pipeline {
    agent {
        kubernetes {
            label 'maven-agent'
            defaultContainer 'maven'
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven
    image: maven:3.9.6-eclipse-temurin-17
    command:
    - cat
    tty: true
"""
        }
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('java-web-app') {
                    sh 'mvn clean verify'
                }
            }
        }

        stage('Install SonarScanner') {
            steps {
                sh '''
                  curl -sSLo sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                  tar -xzf sonar.tar.gz
                  mv sonar-scanner-* /opt/sonar-scanner
                  ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
                  sonar-scanner --version
               '''
            }
        }

        stage('Sonar Scan') {
            steps {
                dir('java-web-app') {
                    withSonarQubeEnv('jenkins-sonarqube') {
                        sh '''
                          sonar-scanner \
                            -Dsonar.projectKey=demo \
                            -Dsonar.sources=src \
                            -Dsonar.java.binaries=target
                        '''
                    }
                }
            }
        }
    }
}
