pipeline {
    agent {
        kubernetes {
            label 'maven'            
         // defaultContainer 'jnlp'
            defaultContainer 'maven'
            yaml """
          apiVersion: v1
          kind: Pod
          spec:
            containers:
            - name: maven
              image: maven:3.9.9-eclipse-temurin-17
              command: ['cat']
              tty: true
            - name: docker
              image: docker:26-cli
              command: ['cat']
              tty: true
              env:
              - name: DOCKER_HOST
                value: tcp://localhost:2375
              volumeMounts:
              - mountPath: /home/jenkins/agent
                name: volume-0

            - name: dind
              image: docker:26-dind
              securityContext:
                privileged: true
              env:
              - name: DOCKER_TLS_CERTDIR
                value: ""
              volumeMounts:
              - mounthPath: /var/lib/docker
                name: docker-graph
              - mountPath: /home/jenkins/agent
                name: volume-0
              volumes:
              - name: docker-graph
                emptyDir: {}

           """
        }
    }

    environment {
        REGISTRY = "harbor.lab.local"      // e.g., docker.io/futureyy
        PROJECT = "java-web-app"
        APP_NAME = "java-web-app"
        IMAGE_TAG = "${BUILD_NUMBER}"
        NAMESPACE = "java-web-app"
    }
    stages {
      stage('Agent Test') {
        steps {
          container('maven') {
            sh '''
              echo "Agent is working"
              java -version
              mvn -version
            '''
          }
        }
      }
      stage('Build') {
        steps {
          container('maven'){
            dir('java-web-app') {
              sh 'mvn clean verify'
            }
          }
        }
      }

        stage('Sonar Scan') {
            steps {
                container('maven') {
                  dir('java-web-app') {
                    withSonarQubeEnv('jenkins-sonarqube') {
                        sh '''
                          mvn sonar:sonar \
                            -Dsonar.projectKey=demo
                        '''
                    }
                 }
              }
           }   
       }
        stage('Build Docker Image') {
            steps {
              container('docker') {
                dir('java-web-app') {
                    sh '''
                      docker version
                      docker build -t ${REGISTRY}/${PROJECT}/${APP_NAME}:${IMAGE_TAG} .
                    '''
                }
            }
        }
      }

        stage('Push Image to Harbor') {
            steps {
              container('docker'){
                withCredentials([usernamePassword(
                  credentialsId: 'harbor-credentials',
                  usernameVariable: 'H_USER',
                  passwordVariable: 'H_PASS'
              )]) {
                  sh """
                     echo $H_PASS | docker login ${REGISTRY} -u $H_USER --password-stdin
                     docker push ${REGISTRY}/${PROJECT}/${APP_NAME}:${IMAGE_TAG}
                  """
                }
            }
        }
      }
       
        stage('Deploy to Kubernetes') {
            steps {
                sh "kubectl apply -f java-web-app/k8s/deployment.yaml -n ${NAMESPACE}"
                sh "kubectl apply -f java-web-app/k8s/service.yaml -n ${NAMESPACE}"
            }
        }
    }

    post {
        success {
            echo "✅ Deployment complete! Access your app at http://10.0.6.20:30080/"
        }
        failure {
            echo "❌ Build or deployment failed."
        }
    }
  }
