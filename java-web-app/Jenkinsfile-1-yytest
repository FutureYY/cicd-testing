pipeline {
    options {
      skipDefaultCheckout(true)
    }
    agent {
        kubernetes {
            label 'maven-agent'
            defaultContainer 'maven'
        }
    }

    environment {
        REGISTRY = "harbor.lab.local"      // e.g., docker.io/futureyy
        PROJECT = "java-web-app"
        APP_NAME = "java-web-app"
        IMAGE_TAG = "${BUILD_NUMBER}"
        NAMESPACE = "java-web-app"
    }
    stages {
      stage('Agent Test') {
        steps {
          sh '''
            echo "Agent is working"
            java -version
            mvn -version
          '''
        }
      }
      stage('Checkout') {
        steps {
          container('maven') {
            sh '''
                apt-get update && apt-get install -y ca-certificates git
                update-ca-certificates
            '''             
            checkout([
              $class: 'GitSCM',
              branches: [[name: '*/main']],
              userRemoteConfigs: [[
                url: 'https://github.com/FutureYY/cicd-testing.git',
                credentialsId: 'github-https'
              ]]
            ])
          }
        }
      }
      stage('Build') {
        steps {
          dir('java-web-app') {
            sh 'mvn clean verify'
          }
        }
      }

        stage('Install SonarScanner') {
            steps {
                sh '''
                  curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                  apt-get update && apt-get install -y unzip
                  unzip -q sonar-scanner.zip
                  mv sonar-scanner-* /opt/sonar-scanner
                  ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
                  sonar-scanner --version
                '''
            }
        }

        stage('Sonar Scan') {
            steps {
                dir('java-web-app') {
                    withSonarQubeEnv('jenkins-sonarqube') {
                        sh '''
                          sonar-scanner \
                            -Dsonar.projectKey=demo \
                            -Dsonar.sources=src \
                            -Dsonar.java.binaries=target
                        '''
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                  apt-get update
                  apt-get install -y docker.io
                  docker --version
                '''
                dir('java-web-app') {
                    sh "docker build -t ${REGISTRY}/${PROJECT}/${APP_NAME}:${IMAGE_TAG} ."
                }
            }
        }

        stage('Push Image to Harbor') {
            steps {
                withCredentials([usernamePassword(
                  credentialsId: 'harbor-credentials',
                  usernameVariable: 'H_USER',
                  passwordVariable: 'H_PASS'
              )]) {
                  sh """
                     echo $H_PASS | docker login ${REGISTRY} -u $H_USER --password-stdin
                     docker push ${REGISTRY}/${PROJECT}/${APP_NAME}:${IMAGE_TAG}
                  """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh "kubectl apply -f java-web-app/k8s/deployment.yaml -n ${NAMESPACE}"
                sh "kubectl apply -f java-web-app/k8s/service.yaml -n ${NAMESPACE}"
            }
        }
    }

    post {
        success {
            echo "✅ Deployment complete! Access your app at http://10.0.6.20:30080/"
        }
        failure {
            echo "❌ Build or deployment failed."
        }
    }
  }
