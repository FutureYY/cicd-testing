pipeline {
    agent {
        kubernetes {
            label 'maven-agent'
            defaultContainer 'maven'
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven
    image: maven:3.9.6-eclipse-temurin-17
    command:
    - cat
    tty: true
"""
        }
    }

    environment {
        REGISTRY = "docker.io/hellopanda123yummy"      // e.g., docker.io/futureyy
        IMAGE_NAME = "java-web-app"
        NAMESPACE = "java-web-app"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('java-web-app') {
                    sh 'mvn clean verify'
                }
            }
        }

        stage('Install SonarScanner') {
            steps {
                sh '''
                  curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                  apt-get update && apt-get install -y unzip
                  unzip -q sonar-scanner.zip
                  mv sonar-scanner-* /opt/sonar-scanner
                  ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
                  sonar-scanner --version
                '''
            }
        }

        stage('Sonar Scan') {
            steps {
                dir('java-web-app') {
                    withSonarQubeEnv('jenkins-sonarqube') {
                        sh '''
                          sonar-scanner \
                            -Dsonar.projectKey=demo \
                            -Dsonar.sources=src \
                            -Dsonar.java.binaries=target
                        '''
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('java-web-app') {
                    sh "docker build -t ${REGISTRY}/${IMAGE_NAME}:latest ."
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                dir('java-web-app') {
                    sh "docker push ${REGISTRY}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh "kubectl apply -f java-web-app/k8s/deployment.yaml -n ${NAMESPACE}"
                sh "kubectl apply -f java-web-app/k8s/service.yaml -n ${NAMESPACE}"
            }
        }
    }

    post {
        success {
            echo "✅ Deployment complete! Access your app at http://10.0.6.20:30080/"
        }
        failure {
            echo "❌ Build or deployment failed."
        }
    }
}
